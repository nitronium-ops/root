# Attendance Model

## Quick Navigation

- [Overview](1-overview.md)
- [System Architecture](2-system-architecture.md)
  - [Application Configuration](2.1-application-configuration.md)
- [Database Models](3-database-models.md)
  - [Member Model](3.1-member-model.md)
  - [Attendance Model](3.2-attendance-model.md)
  - [Streak Model](3.3-streak-model.md)
  - [Project Model](3.4-project-model.md)
- [GraphQL API](4-graphql-api.md)
  - [GraphQL Queries](4.1-graphql-queries.md)
    - [Member Queries](4.1.1-member-queries.md)
    - [Attendance Queries](4.1.2-attendance-queries.md)
    - [Streak Queries](4.1.3-streak-queries.md)
    - [Project Queries](4.1.4-project-queries.md)
  - [GraphQL Mutations](4.2-graphql-mutations.md)
    - [Member Mutations](4.2.1-member-mutations.md)
    - [Attendance Mutations](4.2.2-attendance-mutations.md)
    - [Streak Mutations](4.2.3-streak-mutations.md)
    - [Project Mutations](4.2.4-project-mutations.md)
- [Background Tasks](5-background-tasks.md)
  - [Daily Attendance Task](5.1-daily-attendance-task.md)
- [Deployment and CI/CD](6-deployment-and-cicd.md)
  - [GitHub Actions Workflows](6.1-github-actions-workflows.md)
  - [Docker Deployment](6.2-docker-deployment.md)
- [Security Features](7-security-features.md)
  - [HMAC Authentication](7.1-hmac-authentication.md)

## Table of Contents

- [Attendance Model](#attendance-model)
  - [Overview](#overview)
  - [Data Structures](#data-structures)
    - [Attendance Record](#attendance-record)
    - [Attendance Summary](#attendance-summary)
    - [Helper Data Structures](#helper-data-structures)
  - [Database Schema](#database-schema)
    - [Attendance Table](#attendance-table)
    - [AttendanceSummary Table](#attendancesummary-table)
    - [Automatic Timestamp Updates](#automatic-timestamp-updates)
  - [Attendance Lifecycle](#attendance-lifecycle)
  - [Attendance Marking Process](#attendance-marking-process)
  - [Data Consistency Rules](#data-consistency-rules)
  - [Integration with Other Components](#integration-with-other-components)
  - [Model Implementation Details](#model-implementation-details)

# Attendance Model

Relevant source files

* [migrations/20250114180047\_create\_tables.sql](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql)
* [src/graphql/mutations/attendance\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs)
* [src/graphql/mutations/member\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs)
* [src/models/attendance.rs](https://github.com/amfoss/root/blob/2b58803d/src/models/attendance.rs)

The Attendance Model in Root serves as the foundation for tracking and managing club member attendance records. This document details the data structures, database schema, and functionality related to attendance tracking, including daily attendance records and monthly summary statistics. For information about how attendance is recorded through API calls, see [GraphQL Attendance Mutations](/amfoss/root/4.2.2-attendance-mutations).

## Overview

The Attendance Model consists of two primary components:

1. **Daily Attendance Records** - Individual attendance entries for each member on specific dates
2. **Monthly Attendance Summaries** - Aggregated monthly statistics of attendance for reporting and analysis

Sources: [src/models/attendance.rs1-60](https://github.com/amfoss/root/blob/2b58803d/src/models/attendance.rs#L1-L60) [migrations/20250114180047\_create\_tables.sql21-59](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L21-L59)

## Data Structures

### Attendance Record

The primary attendance record stores information about a member's presence on a specific date, including check-in and check-out times.

| Field | Type | Description |
| --- | --- | --- |
| `attendance_id` | Integer | Primary key uniquely identifying the attendance record |
| `member_id` | Integer | Foreign key referencing the Member table |
| `date` | Date | The date for which attendance is recorded |
| `is_present` | Boolean | Indicates whether the member was present (true) or absent (false) |
| `time_in` | Time (Optional) | The time when the member checked in |
| `time_out` | Time (Optional) | The time when the member checked out or last updated their presence |
| `created_at` | Timestamp | When the attendance record was created (not exposed in GraphQL) |
| `updated_at` | Timestamp | When the attendance record was last updated (not exposed in GraphQL) |

Sources: [src/models/attendance.rs5-17](https://github.com/amfoss/root/blob/2b58803d/src/models/attendance.rs#L5-L17) [migrations/20250114180047\_create\_tables.sql21-37](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L21-L37)

### Attendance Summary

The attendance summary provides aggregated monthly statistics for each member's attendance.

| Field | Type | Description |
| --- | --- | --- |
| `member_id` | Integer | Part of composite primary key, references Member table |
| `year` | Integer | Part of composite primary key, the calendar year |
| `month` | Integer | Part of composite primary key, the calendar month (1-12) |
| `days_attended` | Integer | The number of days the member was present during the month |

Sources: [src/models/attendance.rs19-25](https://github.com/amfoss/root/blob/2b58803d/src/models/attendance.rs#L19-L25) [migrations/20250114180047\_create\_tables.sql53-59](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L53-L59)

### Helper Data Structures

Several additional structures exist to facilitate GraphQL operations:

1. **AttendanceInfo** - A simplified view of attendance data without identifiers
2. **AttendanceSummaryInfo** - A simplified view of attendance summary without member ID
3. **MarkAttendanceInput** - Input structure for marking attendance with HMAC verification
4. **AttendanceWithMember** - Combined attendance and member information for queries

Sources: [src/models/attendance.rs27-59](https://github.com/amfoss/root/blob/2b58803d/src/models/attendance.rs#L27-L59)

## Database Schema

The attendance system is implemented using two primary database tables with specific constraints and relationships.

### Attendance Table

```
CREATE TABLE Attendance (
    attendance_id SERIAL PRIMARY KEY,
    member_id INT REFERENCES Member(member_id) ON DELETE CASCADE,
    date DATE NOT NULL,
    is_present BOOLEAN NOT NULL DEFAULT FALSE,
    time_in TIME,
    time_out TIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CHECK (
        (is_present = TRUE AND time_in IS NOT NULL AND time_out is NOT NULL) OR
        (is_present = FALSE AND time_in IS NULL AND time_out IS NULL)
    ),
    CHECK (is_present = FALSE OR date <= CURRENT_DATE),
    CHECK (time_out IS NULL OR time_out >= time_in),
    UNIQUE (member_id, date)
);

```

Important constraints:

* Foreign key relationship to Member table with cascade deletion
* Check constraint ensuring that present members have both time\_in and time\_out recorded
* Check constraint preventing future-dated attendance records
* Check constraint ensuring time\_out is not earlier than time\_in
* Uniqueness constraint preventing duplicate records for a member on the same date

Sources: [migrations/20250114180047\_create\_tables.sql21-37](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L21-L37)

### AttendanceSummary Table

```
CREATE TABLE AttendanceSummary (
    member_id INT REFERENCES Member(member_id) ON DELETE CASCADE,
    year INT NOT NULL,
    month INT NOT NULL,
    days_attended INT NOT NULL DEFAULT 0,
    primary key (member_id, year, month)
);

```

Key points:

* Composite primary key comprising member\_id, year, and month
* Foreign key relationship to Member table with cascade deletion
* Default value of 0 for days\_attended

Sources: [migrations/20250114180047\_create\_tables.sql53-59](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L53-L59)

### Automatic Timestamp Updates

The system includes a trigger to automatically update the `updated_at` timestamp whenever an attendance record is modified:

```
CREATE TRIGGER update_attendance_timestamp
BEFORE UPDATE ON Attendance
FOR EACH ROW
EXECUTE FUNCTION update_timestamp();

```

Sources: [migrations/20250114180047\_create\_tables.sql48-51](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L48-L51)

## Attendance Lifecycle

The attendance system follows a specific lifecycle for tracking member attendance:

Sources: [src/graphql/mutations/attendance\_mutations.rs1-63](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L1-L63) [migrations/20250114180047\_create\_tables.sql21-59](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L21-L59)

## Attendance Marking Process

Marking attendance involves several steps to ensure security and data integrity:

1. Client generates an HMAC signature using the member ID, date, and a shared secret
2. Client submits a `markAttendance` mutation with member ID, date, and the HMAC signature
3. Server verifies the HMAC signature using the same algorithm and shared secret
4. If verified, the server:
   * Sets `is_present` to `true`
   * Records the current time as `time_in` if it's not already set
   * Updates `time_out` to the current time
5. The database trigger automatically updates the `updated_at` timestamp

This approach with HMAC verification ensures that attendance records can only be created or updated by authorized clients that possess the shared secret.

Sources: [src/graphql/mutations/attendance\_mutations.rs17-62](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L17-L62)

## Data Consistency Rules

The attendance model implements several rules to maintain data consistency:

1. **Completeness Rule**: Present members (`is_present = true`) must have both check-in and check-out times recorded
2. **Chronological Rule**: Check-out time must not be earlier than check-in time
3. **Uniqueness Rule**: Only one attendance record can exist per member per date
4. **Reality Rule**: Attendance can only be marked for current or past dates, not future dates

These rules are enforced through database constraints and application logic.

Sources: [migrations/20250114180047\_create\_tables.sql30-36](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L30-L36)

## Integration with Other Components

The Attendance Model integrates with several other system components:

1. **Member Model**: Each attendance record is associated with a specific member through the `member_id` foreign key
2. **Daily Task**: A scheduled task creates default attendance records for all members at midnight
3. **GraphQL API**: Provides queries for retrieving attendance data and mutations for marking attendance
4. **HMAC Authentication**: Secures attendance marking with cryptographic signatures

For more details on these integrations, see [Member Model](/amfoss/root/3.1-member-model), [Daily Attendance Task](/amfoss/root/5.1-daily-attendance-task), [Attendance Queries](/amfoss/root/4.1.2-attendance-queries), and [HMAC Authentication](/amfoss/root/7.1-hmac-authentication).

Sources: [src/graphql/mutations/attendance\_mutations.rs1-63](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L1-L63)

## Model Implementation Details

The Attendance model and its related structures are implemented using Rust with the following crates:

* `async_graphql` for GraphQL type definitions
* `chrono` for date and time handling
* `sqlx` for database interactions

The model structs use appropriate derive macros to facilitate GraphQL and database operations:

* `#[derive(SimpleObject, FromRow)]` for structures exposed in the GraphQL API
* `#[derive(InputObject)]` for input objects used in mutations

Some fields are explicitly excluded from GraphQL exposure using the `#[graphql(skip)]` attribute to keep internal metadata private.

Sources: [src/models/attendance.rs1-60](https://github.com/amfoss/root/blob/2b58803d/src/models/attendance.rs#L1-L60)