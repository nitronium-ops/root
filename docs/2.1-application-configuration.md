#  Application Configuration

## Quick Navigation

- [overview](1-overview.md)
- [system-architecture](2-system-architecture.md)
  - [application-configuration](2.1-application-configuration.md)
- [database-models](3-database-models.md)
  - [member-model](3.1-member-model.md)
  - [attendance-model](3.2-attendance-model.md)
  - [streak-model](3.3-streak-model.md)
  - [project-model](3.4-project-model.md)
- [graphql-api](4-graphql-api.md)
  - [graphql-queries](4.1-graphql-queries.md)
    - [member-queries](4.1.1-member-queries.md)
    - [attendance-queries](4.1.2-attendance-queries.md)
    - [streak-queries](4.1.3-streak-queries.md)
    - [project-queries](4.1.4-project-queries.md)
  - [graphql-mutations](4.2-graphql-mutations.md)
    - [member-mutations](4.2.1-member-mutations.md)
    - [attendance-mutations](4.2.2-attendance-mutations.md)
    - [streak-mutations](4.2.3-streak-mutations.md)
    - [project-mutations](4.2.4-project-mutations.md)
- [background-tasks](5-background-tasks.md)
  - [daily-attendance-task](5.1-daily-attendance-task.md)
- [deployment-and-cicd](6-deployment-and-cicd.md)
  - [github-actions-workflows](6.1-github-actions-workflows.md)
  - [docker-deployment](6.2-docker-deployment.md)
- [security-features](7-security-features.md)
  - [hmac-authentication](7.1-hmac-authentication.md)

## Table of Contents

- [Application Configuration](#application-configuration)
  - [Configuration Overview](#configuration-overview)
  - [Configuration Structure](#configuration-structure)
  - [Environment Variables](#environment-variables)
  - [Configuration Loading Process](#configuration-loading-process)
  - [Environment-Specific Configurations](#environment-specific-configurations)
    - [Development Mode](#development-mode)
    - [Production Mode](#production-mode)
  - [Database Configuration](#database-configuration)
  - [CORS Configuration](#cors-configuration)
  - [Docker Container Configuration](#docker-container-configuration)
  - [Complete Configuration Flow](#complete-configuration-flow)
  - [Best Practices for Configuration](#best-practices-for-configuration)
  - [Configuration Roadmap](#configuration-roadmap)

# Application Configuration

Relevant source files

* [.dockerignore](https://github.com/amfoss/root/blob/2b58803d/.dockerignore)
* [.env.sample](https://github.com/amfoss/root/blob/2b58803d/.env.sample)
* [.github/workflows/ghcr-deploy.yml](https://github.com/amfoss/root/blob/2b58803d/.github/workflows/ghcr-deploy.yml)
* [Dockerfile](https://github.com/amfoss/root/blob/2b58803d/Dockerfile)
* [src/main.rs](https://github.com/amfoss/root/blob/2b58803d/src/main.rs)

This document details how the Root application manages its configuration through environment variables and initialization processes. It covers the configuration structure, required environment variables, and how these settings influence various subsystems including logging, database connections, and server setup. For information about the overall system architecture, see [System Architecture](/amfoss/root/2-system-architecture).

## Configuration Overview

Root uses a combination of environment variables and initialization functions to configure its runtime behavior. The configuration system follows a centralized approach where all environment variables are gathered in a single place before being used throughout the application.

Sources: [src/main.rs21-37](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L21-L37) [src/main.rs40-60](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L40-L60)

## Configuration Structure

The application uses a `Config` struct to centralize access to environment variables. This struct is defined in the main file and loads all required configuration during application startup.

The `Config` struct encapsulates four key configuration values:

| Field | Purpose | Default | Required |
| --- | --- | --- | --- |
| `env` | Determines operation mode (development/production) | "development" | No |
| `secret_key` | Used for HMAC verification in attendance mutations | None | Yes |
| `database_url` | PostgreSQL connection string | None | Yes |
| `port` | Port on which the HTTP server listens | None | Yes |

Sources: [src/main.rs21-26](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L21-L26)

## Environment Variables

Root expects several environment variables to be set before startup. These can be provided directly in the environment or through a `.env` file (which is loaded automatically using the `dotenv` crate).

The sample `.env` file shows the expected format:

| Variable | Description | Example Value |
| --- | --- | --- |
| `POSTGRES_PASSWORD` | PostgreSQL database password | (No default) |
| `POSTGRES_USER` | PostgreSQL database username | (No default) |
| `POSTGRES_DB` | PostgreSQL database name | (No default) |
| `POSTGRES_HOST` | PostgreSQL server hostname | "localhost" |
| `DATABASE_URL` | Full PostgreSQL connection string | "postgresql://user:password@localhost:5432/dbname" |
| `RUST_ENV` | Application environment | "development" |
| `ROOT_SECRET` | Secret for HMAC verification | "insecuresecret123" |
| `ROOT_PORT` | HTTP server port | "3000" |

Sources: [.env.sample1-12](https://github.com/amfoss/root/blob/2b58803d/.env.sample#L1-L12) [src/main.rs29-37](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L29-L37)

## Configuration Loading Process

During application startup, the configuration is loaded from environment variables and then used to initialize various components of the system.

Sources: [src/main.rs40-60](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L40-L60) [src/main.rs29-37](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L29-L37)

## Environment-Specific Configurations

The application behavior changes based on the `ROOT_ENV` environment variable, which can be set to either "development" or "production". This affects primarily the logging configuration.

### Development Mode

When running in development mode:

* Verbose tracing with log level set to "trace"
* Logs output to both console (with ANSI colors) and a log file
* GraphQL playground accessible

### Production Mode

When running in production mode:

* Reduced logging with log level set to "info"
* Logs output only to a log file (no console output)
* ANSI colors disabled in logs
* GraphQL playground disabled

Sources: [src/main.rs62-99](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L62-L99) [src/main.rs53](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L53-L53)

## Database Configuration

The database connection is established using the `DATABASE_URL` environment variable. This connection string is used to create a connection pool with specific configuration parameters.

The database connection pool is configured with:

* Minimum connections: 2
* Maximum connections: 3

After the pool is established, database migrations are automatically run to ensure the schema is up-to-date.

Sources: [src/main.rs102-116](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L102-L116)

## CORS Configuration

Cross-Origin Resource Sharing (CORS) is configured to allow specific origins to access the API. The CORS configuration is currently hardcoded in the application.

Sources: [src/main.rs128-139](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L128-L139)

## Docker Container Configuration

When deploying the application as a Docker container, environment variables can be passed to the container at runtime. The Dockerfile does not contain any default configuration values, meaning all required environment variables must be provided when running the container.

The Docker build process:

1. Uses a multi-stage build approach for smaller image size
2. Builds the application in release mode
3. Copies only the built binary to the final image
4. Runs the binary without passing any configuration

Sources: [Dockerfile1-22](https://github.com/amfoss/root/blob/2b58803d/Dockerfile#L1-L22)

## Complete Configuration Flow

This diagram shows the complete flow of configuration through the application, from environment variables to the individual components that rely on them.

Sources: [src/main.rs40-60](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L40-L60)

## Best Practices for Configuration

1. **Environment Files**: Use `.env` files for local development, but ensure secrets are not committed to version control
2. **Required Variables**: Always set `ROOT_SECRET`, `DATABASE_URL`, and `ROOT_PORT`
3. **Environment-Specific Settings**: Use `ROOT_ENV=production` for production deployments
4. **Docker Deployment**: When deploying with Docker, provide all required environment variables

## Configuration Roadmap

As noted in the codebase comments, there are plans to replace the current manual configuration approach with the `Config.rs` crate for more robust configuration management:

> // TODO: Replace with `Config.rs` crate.

This would provide additional features like:

* Type validation
* Default values
* Configuration file support
* Nested configuration structures

Sources: [src/main.rs20-21](https://github.com/amfoss/root/blob/2b58803d/src/main.rs#L20-L21)