#  Docker Deployment

## Quick Navigation

- [overview](1-overview.md)
- [system-architecture](2-system-architecture.md)
  - [application-configuration](2.1-application-configuration.md)
- [database-models](3-database-models.md)
  - [member-model](3.1-member-model.md)
  - [attendance-model](3.2-attendance-model.md)
  - [streak-model](3.3-streak-model.md)
  - [project-model](3.4-project-model.md)
- [graphql-api](4-graphql-api.md)
  - [graphql-queries](4.1-graphql-queries.md)
    - [member-queries](4.1.1-member-queries.md)
    - [attendance-queries](4.1.2-attendance-queries.md)
    - [streak-queries](4.1.3-streak-queries.md)
    - [project-queries](4.1.4-project-queries.md)
  - [graphql-mutations](4.2-graphql-mutations.md)
    - [member-mutations](4.2.1-member-mutations.md)
    - [attendance-mutations](4.2.2-attendance-mutations.md)
    - [streak-mutations](4.2.3-streak-mutations.md)
    - [project-mutations](4.2.4-project-mutations.md)
- [background-tasks](5-background-tasks.md)
  - [daily-attendance-task](5.1-daily-attendance-task.md)
- [deployment-and-cicd](6-deployment-and-cicd.md)
  - [github-actions-workflows](6.1-github-actions-workflows.md)
  - [docker-deployment](6.2-docker-deployment.md)
- [security-features](7-security-features.md)
  - [hmac-authentication](7.1-hmac-authentication.md)

## Table of Contents

- [Docker Deployment](#docker-deployment)
  - [Docker Image Architecture](#docker-image-architecture)
  - [Build Process Details](#build-process-details)
    - [Builder Stage](#builder-stage)
    - [Release Stage](#release-stage)
  - [Environment Configuration](#environment-configuration)
  - [GitHub Container Registry Deployment](#github-container-registry-deployment)
    - [Image Tagging Strategy](#image-tagging-strategy)
  - [Running the Docker Container](#running-the-docker-container)
    - [Local Development](#local-development)
    - [Production Deployment](#production-deployment)
  - [Deployment Flow Diagram](#deployment-flow-diagram)
  - [Benefits of the Docker Deployment](#benefits-of-the-docker-deployment)

# Docker Deployment

Relevant source files

* [.dockerignore](https://github.com/amfoss/root/blob/2b58803d/.dockerignore)
* [.env.sample](https://github.com/amfoss/root/blob/2b58803d/.env.sample)
* [.github/workflows/ghcr-deploy.yml](https://github.com/amfoss/root/blob/2b58803d/.github/workflows/ghcr-deploy.yml)
* [Dockerfile](https://github.com/amfoss/root/blob/2b58803d/Dockerfile)

This document covers how the Root application is containerized using Docker and deployed to GitHub Container Registry (GHCR). It explains the Docker configuration, build process, automated deployment workflow, and how to run the containerized application in both development and production environments. For information about the complete CI/CD pipeline, see [GitHub Actions Workflows](/amfoss/root/6.1-github-actions-workflows).

## Docker Image Architecture

The Root service uses a multi-stage Docker build to create a minimal production image containing only the compiled binary, while keeping intermediate build artifacts separate.

Sources: [Dockerfile1-21](https://github.com/amfoss/root/blob/2b58803d/Dockerfile#L1-L21)

## Build Process Details

The Dockerfile defines two distinct stages:

### Builder Stage

This stage compiles the Rust application:

1. Uses `rust:slim-bullseye` as the base image
2. Creates a cargo project and copies dependency files
3. Builds dependencies as a separate cached layer
4. Copies source code and migration files
5. Rebuilds specifically for the application binary

### Release Stage

This stage creates the minimal production image:

1. Uses lightweight `debian:bullseye-slim` as the base image
2. Copies only the compiled binary (`/builder/target/release/root`) to `/usr/local/bin`
3. Sets this binary as the container's entry point

The `.dockerignore` file optimizes the build by excluding unnecessary files from the Docker context:

```
Dockerfile
target
docs
.dockerignore
.env.sample
.gitignore
.git

```

Sources: [Dockerfile1-21](https://github.com/amfoss/root/blob/2b58803d/Dockerfile#L1-L21) [.dockerignore1-9](https://github.com/amfoss/root/blob/2b58803d/.dockerignore#L1-L9)

## Environment Configuration

The Root application requires the following environment variables:

| Variable | Purpose | Example Value |
| --- | --- | --- |
| POSTGRES\_PASSWORD | Database password | password123 |
| POSTGRES\_USER | Database username | root\_user |
| POSTGRES\_DB | Database name | root\_db |
| POSTGRES\_HOST | Database hostname | postgres |
| DATABASE\_URL | PostgreSQL connection string | postgresql://root\_user:password123@postgres:5432/root\_db |
| RUST\_ENV | Runtime environment | production |
| ROOT\_SECRET | Secret for HMAC verification | securetoken456 |
| ROOT\_PORT | HTTP server port | 3000 |

These environment variables are typically provided when running the Docker container. A sample configuration can be found in `.env.sample`.

Sources: [.env.sample1-12](https://github.com/amfoss/root/blob/2b58803d/.env.sample#L1-L12)

## GitHub Container Registry Deployment

Root is automatically built and published to GitHub Container Registry via a workflow defined in `.github/workflows/ghcr-deploy.yml`.

The workflow is triggered by:

* Pushes to the `main` branch
* Manual workflow dispatch

It performs these steps:

1. Checks out the repository
2. Authenticates with GitHub Container Registry
3. Extracts metadata for tagging
4. Builds and pushes the Docker image

Sources: [.github/workflows/ghcr-deploy.yml1-56](https://github.com/amfoss/root/blob/2b58803d/.github/workflows/ghcr-deploy.yml#L1-L56)

### Image Tagging Strategy

The deployment pipeline applies several tags to each image:

* `latest` - For the most recent build from main branch
* Date-based tags (`YYYYMMDD`) - For scheduled builds
* Reference tags - For Git tags and PRs
* SHA-based tags - Using the Git commit hash

This provides flexibility when referencing specific versions for deployment.

Sources: [.github/workflows/ghcr-deploy.yml34-45](https://github.com/amfoss/root/blob/2b58803d/.github/workflows/ghcr-deploy.yml#L34-L45)

## Running the Docker Container

### Local Development

To run the Root Docker image locally:

1. Pull the image:
2. Create a `.env` file with required configuration
3. Run the container:

### Production Deployment

For production environments, a Docker Compose setup is recommended:

This configuration:

1. Runs the Root service and a PostgreSQL database
2. Maps port 3000 to the host
3. Configures the database connection details
4. Persists PostgreSQL data in a Docker volume

## Deployment Flow Diagram

The following diagram illustrates how the Docker deployment integrates with the broader CI/CD pipeline:

Sources: [.github/workflows/ghcr-deploy.yml1-56](https://github.com/amfoss/root/blob/2b58803d/.github/workflows/ghcr-deploy.yml#L1-L56)

## Benefits of the Docker Deployment

The Docker-based deployment approach for Root provides several advantages:

1. **Consistent environments**: Eliminates "works on my machine" problems
2. **Isolation**: Application dependencies are contained within the image
3. **Simple scaling**: Easy to deploy multiple instances
4. **Efficient updates**: Only pull new images when deploying updates
5. **Minimal image size**: Multi-stage build creates a lean production image
6. **Automated builds**: New images are automatically built on code changes

Sources: [Dockerfile1-21](https://github.com/amfoss/root/blob/2b58803d/Dockerfile#L1-L21) [.github/workflows/ghcr-deploy.yml1-56](https://github.com/amfoss/root/blob/2b58803d/.github/workflows/ghcr-deploy.yml#L1-L56)