# Streak Mutations

## Quick Navigation

- [Overview](1-overview.md)
- [System Architecture](2-system-architecture.md)
  - [Application Configuration](2.1-application-configuration.md)
- [Database Models](3-database-models.md)
  - [Member Model](3.1-member-model.md)
  - [Attendance Model](3.2-attendance-model.md)
  - [Streak Model](3.3-streak-model.md)
  - [Project Model](3.4-project-model.md)
- [GraphQL API](4-graphql-api.md)
  - [GraphQL Queries](4.1-graphql-queries.md)
    - [Member Queries](4.1.1-member-queries.md)
    - [Attendance Queries](4.1.2-attendance-queries.md)
    - [Streak Queries](4.1.3-streak-queries.md)
    - [Project Queries](4.1.4-project-queries.md)
  - [GraphQL Mutations](4.2-graphql-mutations.md)
    - [Member Mutations](4.2.1-member-mutations.md)
    - [Attendance Mutations](4.2.2-attendance-mutations.md)
    - [Streak Mutations](4.2.3-streak-mutations.md)
    - [Project Mutations](4.2.4-project-mutations.md)
- [Background Tasks](5-background-tasks.md)
  - [Daily Attendance Task](5.1-daily-attendance-task.md)
- [Deployment and CI/CD](6-deployment-and-cicd.md)
  - [GitHub Actions Workflows](6.1-github-actions-workflows.md)
  - [Docker Deployment](6.2-docker-deployment.md)
- [Security Features](7-security-features.md)
  - [HMAC Authentication](7.1-hmac-authentication.md)

## Table of Contents

- [Streak Mutations](#streak-mutations)
  - [Purpose and Scope](#purpose-and-scope)
  - [Overview of Streak Mutations](#overview-of-streak-mutations)
    - [Mutation Flow](#mutation-flow)
  - [Available Mutations](#available-mutations)
    - [incrementStreak](#incrementstreak)
      - [Operation Details](#operation-details)
    - [resetStreak](#resetstreak)
      - [Operation Details](#operation-details)
  - [Input and Return Types](#input-and-return-types)
    - [StreakInput](#streakinput)
    - [Streak Return Object](#streak-return-object)
  - [Database Operations](#database-operations)
    - [incrementStreak SQL Operation](#incrementstreak-sql-operation)
    - [resetStreak SQL Operation](#resetstreak-sql-operation)
  - [System Integration](#system-integration)
  - [Usage Examples](#usage-examples)
    - [Incrementing a Member's Streak](#incrementing-a-members-streak)
    - [Resetting a Member's Streak](#resetting-a-members-streak)
  - [Implementation Details](#implementation-details)

# Streak Mutations

Relevant source files

* [src/graphql/mutations/streak\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs)

## Purpose and Scope

This document covers the GraphQL mutations for managing status update streaks in the Root system. Streak mutations allow applications to update and manage streak counters that track member activity consistency. These mutations specifically handle the incrementing and resetting of streak counts in the database.

For information about retrieving streak data, see [Streak Queries](/amfoss/root/4.1.3-streak-queries).

Sources: [src/graphql/mutations/streak\_mutations.rs1-55](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L1-L55)

## Overview of Streak Mutations

The Streak Mutations module provides two primary GraphQL mutations for modifying streak data:

1. `incrementStreak` - Increases a member's current streak count and updates maximum streak if necessary
2. `resetStreak` - Resets or decrements a member's streak based on current status

These mutations interact with the `StatusUpdateStreak` database table and return updated streak information.

### Mutation Flow

Sources: [src/graphql/mutations/streak\_mutations.rs8-55](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L8-L55)

## Available Mutations

### incrementStreak

The `incrementStreak` mutation increases a member's current streak count by 1. If the member has no existing streak record, it creates a new one with initial values.

#### Operation Details

* **Input**: `StreakInput` containing `member_id`
* **Return**: Updated `Streak` object
* **Behavior**:
  + For new members: Creates streak record with current\_streak = 1, max\_streak = 1
  + For existing members: Increments current\_streak by 1 if positive, resets to 1 if negative
  + Updates max\_streak if the new current\_streak value exceeds the previous maximum

Sources: [src/graphql/mutations/streak\_mutations.rs13-34](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L13-L34)

### resetStreak

The `resetStreak` mutation resets a member's streak, typically used when they miss an activity or fail to update their status.

#### Operation Details

* **Input**: `StreakInput` containing `member_id`
* **Return**: Updated `Streak` object
* **Behavior**:
  + For new members: Creates streak record with current\_streak = 0, max\_streak = 0
  + For existing members with positive streak: Sets current\_streak to 0
  + For existing members with zero or negative streak: Decrements current\_streak further (making it more negative)

Sources: [src/graphql/mutations/streak\_mutations.rs36-54](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L36-L54)

## Input and Return Types

### StreakInput

Both mutations accept a `StreakInput` parameter with the following structure:

| Field | Type | Description |
| --- | --- | --- |
| member\_id | ID! | Required identifier for the member whose streak is being updated |

Sources: [src/graphql/mutations/streak\_mutations.rs6](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L6-L6)

### Streak Return Object

Both mutations return a `Streak` object with the following fields:

| Field | Type | Description |
| --- | --- | --- |
| member\_id | ID! | Identifier of the member |
| current\_streak | Int! | Current consecutive streak count |
| max\_streak | Int! | Maximum streak ever achieved by this member |

Sources: [src/graphql/mutations/streak\_mutations.rs6](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L6-L6)

## Database Operations

### incrementStreak SQL Operation

The `incrementStreak` mutation executes the following SQL operation:

This SQL uses an "upsert" pattern (INSERT with ON CONFLICT) to handle both creating new records and updating existing ones in a single operation.

Sources: [src/graphql/mutations/streak\_mutations.rs17-29](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L17-L29)

### resetStreak SQL Operation

The `resetStreak` mutation executes the following SQL operation:

This operation also uses the upsert pattern, providing different streak behavior when resetting.

Sources: [src/graphql/mutations/streak\_mutations.rs39-49](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L39-L49)

## System Integration

The Streak Mutations component integrates with the broader Root system architecture as follows:

Sources: [src/graphql/mutations/streak\_mutations.rs1-55](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L1-L55)

## Usage Examples

### Incrementing a Member's Streak

Example response:

### Resetting a Member's Streak

Example response:

Sources: [src/graphql/mutations/streak\_mutations.rs13-34](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L13-L34) [src/graphql/mutations/streak\_mutations.rs36-54](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L36-L54)

## Implementation Details

The Streak Mutations are implemented using:

* Rust's `async-graphql` crate for GraphQL functionality
* `sqlx` for database operations against PostgreSQL
* SQL transactions for data consistency

The mutation handlers follow a common pattern:

1. Extract the database pool from the GraphQL context
2. Prepare and execute the SQL query with the member\_id parameter
3. Return the updated streak information as a structured object

Sources: [src/graphql/mutations/streak\_mutations.rs1-5](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L1-L5) [src/graphql/mutations/streak\_mutations.rs8-12](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L8-L12)