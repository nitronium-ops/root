#  Attendance Mutations

## Quick Navigation

- [overview](1-overview.md)
- [system-architecture](2-system-architecture.md)
  - [application-configuration](2.1-application-configuration.md)
- [database-models](3-database-models.md)
  - [member-model](3.1-member-model.md)
  - [attendance-model](3.2-attendance-model.md)
  - [streak-model](3.3-streak-model.md)
  - [project-model](3.4-project-model.md)
- [graphql-api](4-graphql-api.md)
  - [graphql-queries](4.1-graphql-queries.md)
    - [member-queries](4.1.1-member-queries.md)
    - [attendance-queries](4.1.2-attendance-queries.md)
    - [streak-queries](4.1.3-streak-queries.md)
    - [project-queries](4.1.4-project-queries.md)
  - [graphql-mutations](4.2-graphql-mutations.md)
    - [member-mutations](4.2.1-member-mutations.md)
    - [attendance-mutations](4.2.2-attendance-mutations.md)
    - [streak-mutations](4.2.3-streak-mutations.md)
    - [project-mutations](4.2.4-project-mutations.md)
- [background-tasks](5-background-tasks.md)
  - [daily-attendance-task](5.1-daily-attendance-task.md)
- [deployment-and-cicd](6-deployment-and-cicd.md)
  - [github-actions-workflows](6.1-github-actions-workflows.md)
  - [docker-deployment](6.2-docker-deployment.md)
- [security-features](7-security-features.md)
  - [hmac-authentication](7.1-hmac-authentication.md)

## Table of Contents

- [Attendance Mutations](#attendance-mutations)
  - [Purpose and Scope](#purpose-and-scope)
  - [Overview](#overview)
  - [Available Mutations](#available-mutations)
    - [markAttendance](#markattendance)
      - [Input Parameters](#input-parameters)
  - [HMAC Authentication](#hmac-authentication)
    - [Signature Generation Process](#signature-generation-process)
  - [Database Operations](#database-operations)
  - [Attendance Model and Constraints](#attendance-model-and-constraints)
    - [Database Constraints:](#database-constraints)
  - [Usage Example](#usage-example)
  - [Error Handling](#error-handling)

# Attendance Mutations

Relevant source files

* [migrations/20250114180047\_create\_tables.sql](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql)
* [src/graphql/mutations/attendance\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs)
* [src/graphql/mutations/member\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs)

## Purpose and Scope

This document details the GraphQL mutations available for managing attendance records in the Root system. These mutations are responsible for recording member attendance with secure verification. For information about querying attendance data, see [Attendance Queries](/amfoss/root/4.1.2-attendance-queries).

Sources: [src/graphql/mutations/attendance\_mutations.rs1-63](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L1-L63)

## Overview

Attendance mutations allow authorized clients to mark a member's attendance in the system. The process includes HMAC authentication to ensure that only authorized clients can record attendance data. When an attendance record is marked, the system updates the corresponding database entry with check-in and check-out times.

Sources: [src/graphql/mutations/attendance\_mutations.rs19-62](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L19-L62)

## Available Mutations

### markAttendance

The `markAttendance` mutation is the sole mutation provided for attendance management. It records a member's attendance for a specific date with security verification.

#### Input Parameters

The mutation accepts a `MarkAttendanceInput` object with the following fields:

| Field | Type | Description |
| --- | --- | --- |
| `member_id` | Int | The unique identifier of the member |
| `date` | Date | The date for which attendance is being marked |
| `hmac_signature` | String | A hex-encoded HMAC-SHA256 signature for verification |

Sources: [src/graphql/mutations/attendance\_mutations.rs19-24](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L19-L24)

## HMAC Authentication

To ensure security, the `markAttendance` mutation requires HMAC authentication. This prevents unauthorized attendance marking and potential abuse.

### Signature Generation Process

1. The server computes an expected HMAC signature using:

   * The secret key (`ROOT_SECRET` from the application context)
   * A message created by concatenating the member ID and date: `member_id + date`
2. The computed signature is compared with the one provided in the request.
3. If signatures match, the mutation proceeds; otherwise, it returns an error.

Sources: [src/graphql/mutations/attendance\_mutations.rs29-43](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L29-L43)

## Database Operations

When a valid attendance marking request is received, the system performs the following operations:

1. Records the current time in the Asia/Kolkata timezone
2. Updates the attendance record for the specified member and date:
   * Sets `time_in` if it's currently NULL (first check-in of the day)
   * Always updates `time_out` to the current time
   * Sets `is_present` to TRUE
3. Returns the updated attendance record

Sources: [src/graphql/mutations/attendance\_mutations.rs45-62](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L45-L62)

## Attendance Model and Constraints

The attendance model in the database has several important constraints that are enforced during mutation operations:

| Field | Type | Description |
| --- | --- | --- |
| `attendance_id` | SERIAL | Primary key |
| `member_id` | INT | Foreign key referencing Member table |
| `date` | DATE | Date of attendance |
| `is_present` | BOOLEAN | Whether the member was present |
| `time_in` | TIME | First check-in time |
| `time_out` | TIME | Last check-out time |
| `created_at` | TIMESTAMP | Record creation timestamp |
| `updated_at` | TIMESTAMP | Record update timestamp |

### Database Constraints:

* A member can have only one attendance record per date (enforced by a unique constraint)
* When `is_present` is TRUE, both `time_in` and `time_out` must be non-NULL
* When `is_present` is FALSE, both `time_in` and `time_out` must be NULL
* The `time_out` must be greater than or equal to `time_in`
* Attendance can only be marked for the current date or past dates

The `updated_at` field is automatically updated whenever the record changes through a database trigger.

Sources: [migrations/20250114180047\_create\_tables.sql21-51](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L21-L51)

## Usage Example

To mark a member's attendance, clients must:

1. Calculate the HMAC signature using the shared secret key
2. Send a GraphQL mutation with the proper input

On success, the mutation returns the updated attendance record. On HMAC verification failure, it returns an error message.

Sources: [src/graphql/mutations/attendance\_mutations.rs19-62](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L19-L62)

## Error Handling

The attendance mutation can produce the following errors:

1. **HMAC Verification Failed**: When the provided signature doesn't match the expected one
2. **Database Errors**: When constraints are violated (e.g., trying to mark attendance for a future date)
3. **Hexadecimal Decoding Errors**: If the provided signature is not valid hexadecimal

These errors are returned as standard GraphQL errors in the response.

Sources: [src/graphql/mutations/attendance\_mutations.rs38-43](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L38-L43)