#  Hmac Authentication

## Quick Navigation

- [overview](1-overview.md)
- [system-architecture](2-system-architecture.md)
  - [application-configuration](2.1-application-configuration.md)
- [database-models](3-database-models.md)
  - [member-model](3.1-member-model.md)
  - [attendance-model](3.2-attendance-model.md)
  - [streak-model](3.3-streak-model.md)
  - [project-model](3.4-project-model.md)
- [graphql-api](4-graphql-api.md)
  - [graphql-queries](4.1-graphql-queries.md)
    - [member-queries](4.1.1-member-queries.md)
    - [attendance-queries](4.1.2-attendance-queries.md)
    - [streak-queries](4.1.3-streak-queries.md)
    - [project-queries](4.1.4-project-queries.md)
  - [graphql-mutations](4.2-graphql-mutations.md)
    - [member-mutations](4.2.1-member-mutations.md)
    - [attendance-mutations](4.2.2-attendance-mutations.md)
    - [streak-mutations](4.2.3-streak-mutations.md)
    - [project-mutations](4.2.4-project-mutations.md)
- [background-tasks](5-background-tasks.md)
  - [daily-attendance-task](5.1-daily-attendance-task.md)
- [deployment-and-cicd](6-deployment-and-cicd.md)
  - [github-actions-workflows](6.1-github-actions-workflows.md)
  - [docker-deployment](6.2-docker-deployment.md)
- [security-features](7-security-features.md)
  - [hmac-authentication](7.1-hmac-authentication.md)

## Table of Contents

- [HMAC Authentication](#hmac-authentication)
  - [Purpose and Scope](#purpose-and-scope)
  - [What is HMAC Authentication?](#what-is-hmac-authentication)
  - [Implementation in Root](#implementation-in-root)
  - [Authentication Process Details](#authentication-process-details)
  - [Code Implementation](#code-implementation)
  - [MarkAttendanceInput Structure](#markattendanceinput-structure)
  - [System Integration](#system-integration)
  - [Client Implementation Requirements](#client-implementation-requirements)
  - [Security Considerations](#security-considerations)
  - [Related Wiki Pages](#related-wiki-pages)

# HMAC Authentication

Relevant source files

* [migrations/20250114180047\_create\_tables.sql](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql)
* [src/graphql/mutations/attendance\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs)
* [src/graphql/mutations/member\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs)

## Purpose and Scope

This document describes the HMAC (Hash-based Message Authentication Code) authentication system implemented in the Root backend. This security feature is specifically used to verify the authenticity of attendance marking requests, ensuring that only authorized clients can record member attendance. For information about the Attendance system itself, see [Attendance Model](/amfoss/root/3.2-attendance-model) and [Attendance Mutations](/amfoss/root/4.2.2-attendance-mutations).

## What is HMAC Authentication?

HMAC authentication is a cryptographic technique that combines a secret key with a message to produce a unique hash (signature). This signature allows the server to verify that:

1. The request was created by a client that possesses the shared secret key
2. The message hasn't been tampered with during transmission

In Root, HMAC-SHA256 is used to authenticate attendance marking requests.

Sources: [src/graphql/mutations/attendance\_mutations.rs5-12](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L5-L12)

## Implementation in Root

Root implements HMAC authentication for the `markAttendance` GraphQL mutation. The system uses the following components:

* **Algorithm**: HMAC-SHA256
* **Secret key**: Stored as an environment variable (`ROOT_SECRET`)
* **Message content**: Combination of member ID and date (`{member_id}{date}`)
* **Verification process**: Server-side signature generation and comparison

Sources: [src/graphql/mutations/attendance\_mutations.rs19-43](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L19-L43)

## Authentication Process Details

When a client sends an attendance marking request, the server performs the following steps:

1. Extracts the member ID, date, and HMAC signature from the request
2. Retrieves the secret key from the application context
3. Generates the expected signature using the same algorithm as the client
4. Compares the received signature with the expected signature
5. If they match, processes the attendance; otherwise, returns an error

Sources: [src/graphql/mutations/attendance\_mutations.rs29-43](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L29-L43)

## Code Implementation

The HMAC authentication is implemented in the `markAttendance` mutation resolver. The key parts of the implementation are:

1. **Secret key retrieval**:

2. **HMAC generation**:

3. **Signature verification**:

Sources: [src/graphql/mutations/attendance\_mutations.rs29-43](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L29-L43)

## MarkAttendanceInput Structure

The `MarkAttendanceInput` struct used in the mutation includes the following fields:

| Field | Type | Description |
| --- | --- | --- |
| member\_id | Integer | ID of the member marking attendance |
| date | Date | Date for which attendance is being marked |
| hmac\_signature | String | Hex-encoded HMAC signature for authentication |

When the attendance is marked successfully, the mutation updates the following fields in the database:

* `time_in`: Set to the current time if it was previously null
* `time_out`: Always set to the current time
* `is_present`: Set to TRUE

Sources: [src/graphql/mutations/attendance\_mutations.rs20-24](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L20-L24) [src/graphql/mutations/attendance\_mutations.rs45-59](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L45-L59)

## System Integration

Sources: [src/graphql/mutations/attendance\_mutations.rs1-63](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L1-L63)

## Client Implementation Requirements

For clients to successfully authenticate their attendance marking requests:

1. They must have access to the same secret key (`ROOT_SECRET`) as the server
2. They must implement the HMAC-SHA256 algorithm
3. They must format the message as `{member_id}{date}`
4. They must hex-encode the resulting HMAC signature
5. They must include the signature in the `hmac_signature` field of the `MarkAttendanceInput`

## Security Considerations

* The `ROOT_SECRET` environment variable must be kept secure and should not be exposed to unauthorized parties
* All client applications that need to mark attendance must be trusted with the secret key
* The HMAC signature prevents replay attacks when used with unique date values
* The system assumes that the date is part of the signed message, which prevents marking attendance for arbitrary dates

## Related Wiki Pages

* [Security Features](/amfoss/root/7-security-features) - Overview of all security features in Root
* [Attendance Model](/amfoss/root/3.2-attendance-model) - Details of the attendance data model
* [Attendance Mutations](/amfoss/root/4.2.2-attendance-mutations) - Documentation of all attendance-related mutations
* [GraphQL API](/amfoss/root/4-graphql-api) - Overview of the complete GraphQL API