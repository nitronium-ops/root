#  Daily Attendance Task

## Quick Navigation

- [overview](1-overview.md)
- [system-architecture](2-system-architecture.md)
  - [application-configuration](2.1-application-configuration.md)
- [database-models](3-database-models.md)
  - [member-model](3.1-member-model.md)
  - [attendance-model](3.2-attendance-model.md)
  - [streak-model](3.3-streak-model.md)
  - [project-model](3.4-project-model.md)
- [graphql-api](4-graphql-api.md)
  - [graphql-queries](4.1-graphql-queries.md)
    - [member-queries](4.1.1-member-queries.md)
    - [attendance-queries](4.1.2-attendance-queries.md)
    - [streak-queries](4.1.3-streak-queries.md)
    - [project-queries](4.1.4-project-queries.md)
  - [graphql-mutations](4.2-graphql-mutations.md)
    - [member-mutations](4.2.1-member-mutations.md)
    - [attendance-mutations](4.2.2-attendance-mutations.md)
    - [streak-mutations](4.2.3-streak-mutations.md)
    - [project-mutations](4.2.4-project-mutations.md)
- [background-tasks](5-background-tasks.md)
  - [daily-attendance-task](5.1-daily-attendance-task.md)
- [deployment-and-cicd](6-deployment-and-cicd.md)
  - [github-actions-workflows](6.1-github-actions-workflows.md)
  - [docker-deployment](6.2-docker-deployment.md)
- [security-features](7-security-features.md)
  - [hmac-authentication](7.1-hmac-authentication.md)

## Table of Contents

- [Daily Attendance Task](#daily-attendance-task)
  - [Purpose and Function](#purpose-and-function)
  - [Task Scheduling Architecture](#task-scheduling-architecture)
  - [Implementation Details](#implementation-details)
    - [Function Hierarchy](#function-hierarchy)
    - [Execution Flow](#execution-flow)
  - [Database Operations](#database-operations)
    - [Creating Default Attendance Records](#creating-default-attendance-records)
    - [Updating Attendance Summaries](#updating-attendance-summaries)
  - [Database Schema Interactions](#database-schema-interactions)
  - [Error Handling](#error-handling)
  - [System Integration](#system-integration)

# Daily Attendance Task

Relevant source files

* [src/daily\_task/mod.rs](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs)

This document describes the automated Daily Attendance Task in the Root system. This background process runs at 12:30 AM Indian Standard Time (IST) daily to create default attendance records and update attendance summaries. The task operates independently from API requests and ensures consistent attendance tracking across the platform.

For information about GraphQL mutations related to attendance, see [Attendance Mutations](/amfoss/root/4.2.2-attendance-mutations).

## Purpose and Function

The Daily Attendance Task serves two primary functions:

1. Creates default attendance records for all members for the current day
2. Updates monthly attendance summaries based on the previous day's attendance

This automation ensures that attendance data is consistently maintained and that monthly statistics remain accurate without manual intervention.

Sources: [src/daily\_task/mod.rs37-40](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L37-L40)

## Task Scheduling Architecture

The Daily Attendance Task uses Tokio's asynchronous runtime to schedule execution at the same time each day. The process follows a continuous loop pattern:

The task operates with the following sequence:

1. Calculates the next run time (00:30:00 in Kolkata timezone)
2. Determines the duration until that time
3. Uses Tokio's `sleep_until` function to pause execution
4. Executes the task once the scheduled time arrives
5. Repeats indefinitely

Sources: [src/daily\_task/mod.rs10-35](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L10-L35)

## Implementation Details

### Function Hierarchy

The Daily Attendance Task consists of several functions that work together:

| Function | Purpose |
| --- | --- |
| `run_daily_task_at_midnight` | Main entry point that schedules and executes the task |
| `execute_daily_task` | Retrieves all members and initiates attendance updates |
| `update_attendance` | Creates default attendance records for each member |
| `update_attendance_summary` | Checks previous day's attendance and updates summaries |
| `update_days_attended` | Updates or creates monthly attendance summary records |

Sources: [src/daily\_task/mod.rs10-202](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L10-L202)

### Execution Flow

The task executes with a specific sequence of operations, illustrated below:

Sources: [src/daily\_task/mod.rs40-50](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L40-L50) [src/daily\_task/mod.rs53-93](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L53-L93) [src/daily\_task/mod.rs95-130](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L95-L130) [src/daily\_task/mod.rs132-202](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L132-L202)

## Database Operations

### Creating Default Attendance Records

For each member, the task creates a new attendance record with default values:

* `is_present` set to `false` (member is absent by default)
* `time_in` and `time_out` set to `NULL`

The SQL query uses `ON CONFLICT DO NOTHING` to prevent duplicate records:

Sources: [src/daily\_task/mod.rs62-73](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L62-L73)

### Updating Attendance Summaries

After creating default records, the task updates monthly attendance summaries:

1. Checks if the member was present on the previous day
2. If present, increments the `days_attended` count for the current month
3. If no summary exists for the current month, creates a new summary record

This ensures that monthly attendance statistics remain accurate.

Sources: [src/daily\_task/mod.rs95-130](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L95-L130) [src/daily\_task/mod.rs132-202](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L132-L202)

## Database Schema Interactions

The task interacts with three main database tables:

The task performs these specific database operations:

| Operation | Purpose | SQL Type |
| --- | --- | --- |
| Retrieve members | Get all active members | SELECT |
| Create attendance records | Create default records for current day | INSERT |
| Check previous attendance | Determine if member was present yesterday | SELECT |
| Check existing summaries | Find summary for current month | SELECT |
| Update summary | Increment days\_attended | UPDATE |
| Create new summary | Create record if none exists | INSERT |

Sources: [src/daily\_task/mod.rs42-44](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L42-L44) [src/daily\_task/mod.rs62-73](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L62-L73) [src/daily\_task/mod.rs104-114](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L104-L114) [src/daily\_task/mod.rs137-150](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L137-L150) [src/daily\_task/mod.rs154-169](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L154-L169) [src/daily\_task/mod.rs177-189](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L177-L189)

## Error Handling

The daily task includes error handling at various stages:

1. **Member Retrieval**: If fetching members fails, the error is logged and the task continues running for the next day.
2. **Attendance Record Creation**: If creating an attendance record fails for a member, the error is logged, but the task continues processing other members.
3. **Summary Updates**: If updating a summary fails, the error is logged without preventing other operations.

This robust error handling ensures that even if parts of the process fail, the system will continue functioning and will retry the operations during the next execution cycle.

Sources: [src/daily\_task/mod.rs46-50](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L46-L50) [src/daily\_task/mod.rs75-89](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L75-L89) [src/daily\_task/mod.rs116-129](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L116-L129) [src/daily\_task/mod.rs195-200](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L195-L200)

## System Integration

The Daily Attendance Task is launched during application startup, just after the database connection is established and before the HTTP server starts. It runs in a separate Tokio task to avoid blocking the main application thread.

This task integrates with other Root system components:

* Creates records that are later updated by the **Presense** system
* Maintains the `AttendanceSummary` table used by analytics and reporting features
* Works with the Member model to process all active members

By automatically creating attendance records and maintaining summary data, the Daily Attendance Task forms a critical foundation for the entire attendance tracking functionality within Root.

Sources: [src/daily\_task/mod.rs37-39](https://github.com/amfoss/root/blob/2b58803d/src/daily_task/mod.rs#L37-L39)